<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sudan Play - متجر التطبيقات السوداني</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --------------------------------------
        |  CSS: تحديث الثيم والتدرجات اللونية والحركات
        -------------------------------------- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            /* الألوان الأصلية بتدرجات أعمق وأكثر احترافية */
            --primary: #4a6bff; /* الأزرق */
            --secondary: #ff5e7d; /* الوردي/الأحمر */
            --accent: #2ec4b6; /* الأخضر المائي */
            --dark: #1e1e2f; /* لون خلفية داكن (أنيق) */
            --light: #f4f7f6; /* خلفية فاتحة هادئة */
            --card-bg: #ffffff; /* خلفية البطاقات */
            /* تدرج احترافي جديد */
            --gradient-primary: linear-gradient(135deg, #4a6bff 0%, #0093e9 100%);
            --gradient-secondary: linear-gradient(135deg, #ff5e7d 0%, #ff9a8d 100%);
            --shadow-md: 0 4px 15px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        body {
            background-color: var(--light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--dark);
        }

        /* --- Animations (الحركات الأساسية) --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(74, 107, 255, 0.4); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(74, 107, 255, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(74, 107, 255, 0); }
        }

        /* --- Header / Navigation --- */
        header {
            background-color: var(--card-bg);
            border-bottom: 1px solid #e0e0e0;
            padding: 15px 20px;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 1.8em;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .logo img {
            height: 40px;
            border-radius: 8px;
            margin-left: 10px; 
            background: var(--gradient-primary);
            padding: 5px;
        }
        
        .logo h1 {
            color: var(--dark);
            font-size: 1.5em;
        }

        .nav-links a {
            color: var(--dark);
            text-decoration: none;
            margin-right: 25px;
            font-size: 1em;
            transition: color 0.3s, transform 0.3s;
            position: relative;
            padding: 5px 0;
        }

        .nav-links a:hover {
            color: var(--primary);
            transform: translateY(-2px);
        }
        
        .nav-links a::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 0;
            height: 2px;
            background: var(--gradient-primary);
            transition: width 0.3s ease-in-out;
        }

        .nav-links a:hover::after {
            width: 100%;
            left: 0;
        }

        /* --- Hero Section (الشريط المتحرك) --- */
        .hero {
            background: var(--light);
            padding: 40px 20px;
            text-align: center;
        }
        
        .hero h2 {
            font-size: 2em;
            color: var(--dark);
            margin-bottom: 20px;
            animation: fadeIn 0.8s ease-out;
        }

        .carousel-container {
            max-width: 1200px;
            margin: 0 auto;
            overflow: hidden;
            position: relative;
            padding: 10px 0;
        }

        .carousel-track {
            display: flex;
            transition: transform 0.5s ease-in-out;
            gap: 20px;
        }

        .carousel-item {
            flex-shrink: 0;
            width: 300px; 
            height: 150px;
            border-radius: 15px;
            background-color: var(--dark);
            color: var(--card-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: var(--shadow-md);
            transition: transform 0.3s;
            overflow: hidden;
            position: relative;
            background: var(--gradient-primary); /* تدرج لوني */
        }
        
        .carousel-item:nth-child(2n) {
            background: var(--gradient-secondary);
        }

        .carousel-item-content {
            padding: 20px;
            text-align: right;
            z-index: 1;
        }
        
        .carousel-item h3 {
            font-size: 1.3em;
            margin-bottom: 5px;
        }
        
        .carousel-item p {
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* --- App Showcase --- */
        #apps {
            padding: 40px 20px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        #apps h2 {
            color: var(--dark);
            margin-bottom: 30px;
            font-size: 1.8em;
            font-weight: 600;
        }

        .filter-section {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 30px;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            animation: fadeIn 1s ease-out 0.2s backwards;
        }

        #categoryFilter {
            padding: 12px 18px;
            border-radius: 8px;
            border: 1px solid #ccc;
            background-color: var(--card-bg);
            font-size: 1em;
            min-width: 200px;
            transition: border-color 0.3s;
        }
        
        #categoryFilter:focus {
            border-color: var(--primary);
            box-shadow: 0 0 5px rgba(74, 107, 255, 0.5);
        }

        #apps-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 30px;
        }

        .app-card {
            background-color: var(--card-bg);
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.4s; /* حركة زنبركية */
            cursor: pointer;
            border: 1px solid transparent;
            animation: fadeIn 0.8s ease-out backwards; /* حركة ظهور سلسة */
        }
        
        .app-card:nth-child(2) { animation-delay: 0.1s; }
        .app-card:nth-child(3) { animation-delay: 0.2s; }
        .app-card:nth-child(4) { animation-delay: 0.3s; }
        /* يمكنك إضافة المزيد من التأخير للعناصر الأخرى */

        .app-card:hover {
            transform: translateY(-8px); /* حركة رفع أكبر */
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .app-cover {
            height: 150px;
            overflow: hidden;
            position: relative;
        }

        .app-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }

        .app-info {
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .app-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            object-fit: cover;
            border: 3px solid var(--primary);
            flex-shrink: 0;
            transition: transform 0.3s;
        }
        
        .app-card:hover .app-icon {
            transform: rotate(5deg) scale(1.05); /* حركة خفيفة على الأيقونة عند التمرير */
        }

        .app-title {
            font-size: 1.2em;
            color: var(--dark);
            font-weight: 600;
        }

        .app-category {
            font-size: 0.9em;
            color: var(--primary);
            background-color: rgba(74, 107, 255, 0.1);
            padding: 3px 8px;
            border-radius: 5px;
            display: inline-block;
            margin-top: 5px;
        }

        .app-rating i.filled {
            color: #ffb700;
        }

        .download-btn {
            background: var(--gradient-secondary); /* تدرج لوني للزر */
            color: var(--card-bg);
            border: none;
            padding: 12px 15px;
            width: 90%;
            margin: 0 auto 15px auto;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: transform 0.3s, opacity 0.3s;
            font-weight: bold;
        }

        .download-btn:hover {
            opacity: 0.9;
            transform: scale(0.98);
        }

        /* --- App Details Modal --- */
        .modal-content {
            background-color: var(--card-bg);
            animation: fadeIn 0.4s ease-out; /* حركة ظهور للمودال */
        }

        .details-header {
            border-bottom: 2px solid var(--primary);
        }

        .details-info {
            background: var(--light);
            border: 1px solid #e0e0e0;
        }

        .download-modal-btn {
            background: var(--gradient-primary); /* تدرج لوني لزر المودال */
            box-shadow: var(--shadow-md);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .download-modal-btn:hover {
             transform: translateY(-3px);
             box-shadow: 0 8px 20px rgba(74, 107, 255, 0.4);
        }

        /* تنسيق الـ Toast/Loader (للتناسق مع الألوان الجديدة) */
        .download-btn.loading::after, 
        .download-modal-btn.loading::after {
            border: 3px solid #fff;
            border-top: 3px solid var(--accent);
        }

        #toast-message {
            background-color: var(--dark);
            color: var(--card-bg);
        }


        /* --- Media Queries --- (تصميم متجاوب لم يتغير بشكل كبير) */
        @media (max-width: 768px) {
             .carousel-item {
                width: 90vw; 
                height: 120px;
            }
            #apps-container {
                grid-template-columns: repeat(auto-fill, minmax(100%, 1fr));
            }
        }
    </style>
</head>
<body onload="loadApps()">
    <header>
        <nav>
            <div class="logo">
                <img src="https://via.placeholder.com/40/4a6bff/ffffff?text=SP" alt="Sudan Play Logo">
                <h1>Sudan Play</h1>
            </div>
            <div class="nav-links">
                <a href="#apps"><i class="fas fa-th"></i> التطبيقات</a>
                <a href="#about"><i class="fas fa-info-circle"></i> عن المتجر</a>
                <a href="#contact"><i class="fas fa-envelope"></i> تواصل معنا</a>
            </div>
        </nav>
    </header>

    <section class="hero">
        <h2>اكتشف تطبيقات السودان المميزة</h2>
        <div class="carousel-container">
            <div class="carousel-track" id="featuredCarousel">
                </div>
        </div>
    </section>

    <section id="apps">
        <h2>جميع تطبيقاتنا</h2>
        
        <div class="filter-section">
            <label for="categoryFilter"><i class="fas fa-filter"></i> تصفية حسب الفئة:</label>
            <select id="categoryFilter" onchange="filterApps(this.value)">
                <option value="الكل">الكل</option>
                <option value="ألعاب">ألعاب</option>
                <option value="أدوات">أدوات</option>
                <option value="تواصل">تواصل</option>
                <option value="تعليم">تعليم</option>
                <option value="ترفيه">ترفيه</option>
                <option value="مال وأعمال">مال وأعمال</option>
                <option value="أخرى">أخرى</option>
            </select>
        </div>

        <div id="apps-container">
            </div>
    </section>

    <section id="about" style="background-color: var(--card-bg); padding: 60px 20px; text-align: center;">
        <h2>عن Sudan Play</h2>
        <p style="max-width: 800px; margin: 0 auto; color: #555; line-height: 1.8;">
            Sudan Play هو بوابتك لاكتشاف المحتوى الرقمي الموثوق والمناسب للمستخدم السوداني. نحن نسعى لتقديم أفضل تجربة تحميل، مع التركيز على دعم المطورين المحليين وضمان جودة التطبيقات المقدمة. مهمتنا هي ربط المستخدم بالتكنولوجيا التي تخدمه تم تطويره بواسطة Monty GO SDN-Co.ltd.
        </p>
    </section>

    <section id="contact" style="background-color: var(--light);">
        <h2>تواصل معنا</h2>
        <p>الاستفسارات، و نشر تطبيقك، يرجى ملء النموذج أدناه.</p>
        <form class="contact-form" id="contactForm">
            <input type="text" placeholder="اسمك الكامل" required>
            <input type="email" placeholder="بريدك الإلكتروني" required>
            <textarea placeholder="رسالتك..." rows="5" required></textarea>
            <button type="submit">إرسال الرسالة <i class="fas fa-paper-plane"></i></button>
        </form>
    </section>

    <div id="appDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('appDetailsModal').style.display='none'">&times;</span>
            <div class="details-header">
                <img id="detailsIcon" src="" alt="App Icon">
                <div class="details-text">
                    <h3 id="detailsTitle">اسم التطبيق</h3>
                    <div class="details-meta">
                        <span><strong>الفئة:</strong> <span id="detailsCategory"></span></span>
                    </div>
                </div>
            </div>

            <div class="details-info">
                <div>
                    <p id="detailsRating">4.5</p>
                    <span>التقييم</span>
                </div>
                <div>
                    <p id="detailsDownloads">0</p>
                    <span>تحميل</span>
                </div>
                <div>
                    <p id="detailsSize">50 ميغابايت</p>
                    <span>الحجم</span>
                </div>
                <div>
                    <p id="detailsVersion">1.0.0</p>
                    <span>الإصدار</span>
                </div>
            </div>

            <h4 style="color: var(--dark); margin-bottom: 10px;">الوصف</h4>
            <p id="detailsDescription" class="details-description"></p>

            <h4 style="color: var(--dark); margin-bottom: 10px;">لقطات الشاشة</h4>
            <div id="detailsScreenshots">
                </div>

            <button class="download-modal-btn" onclick="downloadApp(window.currentAppId, this)">تحميل التطبيق الآن <i class="fas fa-download"></i></button>
        </div>
    </div>

    <div id="imageModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <img id="modalImage" src="" alt="Full Screen Screenshot">
        </div>
    </div>

    <div id="toast-message"></div>

    <footer>
        &copy; 2025 Sudan Play. جميع الحقوق محفوظة. - واتساب: 249127432167 - Monty Go SDN-Co.LTD
    </footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script> 
    <script>
        // --------------------------------------
        // |  JavaScript: إضافة حركة الكاروسيل
        // --------------------------------------
        const firebaseConfig = {
          apiKey: "AIzaSyBJE_Ee-Dyh83iny45eH8lVtTSrIVqTzOI",
          authDomain: "sudan-play.firebaseapp.com",
          projectId: "sudan-play",
          storageBucket: "sudan-play.firebasestorage.app",
          messagingSenderId: "981764948623",
          appId: "1:981764948623:web:00e5c9268198f70e39a6fa",
          measurementId: "G-Y6NP2MNQR9"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const appsCollection = db.collection('apps'); 
        
        let currentAppId = null;
        let appsCache = []; // لتخزين التطبيقات مرة واحدة فقط

        function showToast(message, duration = 3000) {
            const toast = document.getElementById("toast-message");
            if (!toast) return;

            toast.textContent = message;
            toast.classList.add("show");

            setTimeout(function(){ 
                toast.classList.remove("show"); 
            }, duration);
        }

        // دالة إنشاء بطاقة التطبيق القياسية
        function createAppCard(app) {
            const appCard = document.createElement('div');
            appCard.classList.add('app-card');
            appCard.setAttribute('data-category', app.category);
            
            const iconSrc = app.iconPath || "https://via.placeholder.com/60/4a6bff/ffffff?text=Icon";
            const coverSrc = app.coverPath || "https://via.placeholder.com/300x150/4a6bff/ffffff?text=Cover";
            
            const ratingValue = parseFloat(app.rating) || 0;
            const fullStars = Array(Math.floor(ratingValue)).fill('<i class="fas fa-star filled"></i>').join('');
            const emptyStars = Array(5 - Math.floor(ratingValue)).fill('<i class="fas fa-star"></i>').join('');

            appCard.innerHTML = `
                <div class="app-cover" onclick="openDetailsModal('${app.id}')">
                    <img src="${coverSrc}" alt="${app.name} Cover">
                    <div class="overlay">
                        <i class="fas fa-search-plus"></i>
                    </div>
                </div>
                <div class="app-info">
                    <img src="${iconSrc}" alt="${app.name} Icon" class="app-icon">
                    <div class="app-text">
                        <h3 class="app-title" onclick="openDetailsModal('${app.id}')">${app.name}</h3>
                        <p class="app-category">${app.category}</p>
                        <div class="app-rating">
                            ${fullStars}
                            ${emptyStars}
                            <span>(${app.downloads || 0} تنزيل)</span>
                        </div>
                    </div>
                </div>
                <button class="download-btn" onclick="downloadApp('${app.id}', this)">تنزيل <i class="fas fa-download"></i></button>
            `;
            return appCard;
        }
        
        // دالة إنشاء عنصر الكاروسيل
        function createCarouselItem(app, index) {
             const carouselItem = document.createElement('div');
            carouselItem.classList.add('carousel-item');
            carouselItem.onclick = () => openDetailsModal(app.id);
            carouselItem.style.background = (index % 2 === 0) ? 
                'var(--gradient-primary)' : 'var(--gradient-secondary)';
            
            carouselItem.innerHTML = `
                <div class="carousel-item-content">
                    <h3>${app.name}</h3>
                    <p>${app.shortDescription || app.category}</p>
                    <button style="background: none; border: 1px solid white; color: white; padding: 5px 15px; border-radius: 5px; margin-top: 10px; cursor: pointer;">
                        مشاهدة التفاصيل
                    </button>
                </div>
                <img src="${app.iconPath || 'https://via.placeholder.com/60/fff/000?text=SP'}" 
                     alt="Icon" 
                     style="height: 100%; object-fit: cover; opacity: 0.2; position: absolute; left: 0; top: 0; border-radius: 0;">
            `;
            return carouselItem;
        }


        // وظيفة تحميل وعرض التطبيقات من Firestore
        function loadApps() {
            const appsContainer = document.getElementById('apps-container');
            const carouselTrack = document.getElementById('featuredCarousel');
            
            appsCollection.orderBy('downloads', 'desc').onSnapshot(snapshot => {
                appsContainer.innerHTML = '';
                carouselTrack.innerHTML = '';
                appsCache = [];
                
                let carouselCount = 0;
                
                snapshot.forEach(doc => {
                    const app = { ...doc.data(), id: doc.id };
                    appsCache.push(app);

                    // 1. ملء الكاروسيل بالتطبيقات الأكثر تحميلاً (10 تطبيقات)
                    if (carouselCount < 10) {
                        carouselTrack.appendChild(createCarouselItem(app, carouselCount));
                        carouselCount++;
                    }

                    // 2. ملء حاوية جميع التطبيقات
                    appsContainer.appendChild(createAppCard(app));
                });

                if (appsCache.length === 0) {
                    appsContainer.innerHTML = '<p class="no-apps" style="grid-column: 1 / -1; text-align: center; padding: 20px; font-size: 1.2em; color: var(--secondary);">لا توجد تطبيقات متاحة حاليًا.</p>';
                    carouselTrack.innerHTML = '';
                    return;
                }
                
                // بدء حركة الكاروسيل بعد التحميل
                if (carouselCount > 0) {
                    startCarousel();
                }

                // تطبيق الفلتر الافتراضي
                filterApps(document.getElementById('categoryFilter').value); 
            });
        }
        
        // **وظيفة حركة الكاروسيل (المركبة)**
        let currentCarouselIndex = 0;
        let carouselInterval;
        const CAROUSEL_VISIBLE_ITEMS = 3; // عدد العناصر الظاهرة في الشاشة الكبيرة

        function startCarousel() {
            const carouselTrack = document.getElementById('featuredCarousel');
            if (!carouselTrack) return;
            
            const items = carouselTrack.children;
            if (items.length === 0) return;

            const itemWidth = items[0].offsetWidth;
            const gap = 20; // المسافة بين العناصر
            const moveDistance = itemWidth + gap;

            function moveCarousel() {
                const totalItems = items.length;
                
                // تحديد عدد العناصر المرئية بناءً على حجم الشاشة
                const visibleItems = window.innerWidth > 768 ? CAROUSEL_VISIBLE_ITEMS : 1; 

                // حساب عدد المرات التي يمكن أن يتحركها الكاروسيل قبل العودة
                const maxIndex = totalItems - 1; // يتحرك حتى آخر عنصر

                currentCarouselIndex++;

                if (currentCarouselIndex >= maxIndex) {
                    currentCarouselIndex = 0; // العودة للبداية
                }
                
                const translation = -(currentCarouselIndex * moveDistance);
                carouselTrack.style.transform = `translateX(${translation}px)`;
            }

            // إيقاف أي فترات زمنية سابقة قبل البدء
            if (carouselInterval) clearInterval(carouselInterval);
            
            // البدء بالتحريك كل 4 ثوانٍ
            carouselInterval = setInterval(moveCarousel, 4000);
            
            // التأكد من تعديل حجم الكاروسيل عند تغيير حجم النافذة
            window.addEventListener('resize', () => {
                // إعادة تشغيل الكاروسيل لضبط المسافة
                clearInterval(carouselInterval);
                currentCarouselIndex = 0;
                carouselTrack.style.transform = 'translateX(0)';
                startCarousel();
            });
        }


        // وظيفة عرض التفاصيل (لم تتغير)
        window.openDetailsModal = function(id) {
            // ... (الكود الخاص بجلب البيانات وعرض المودال) ...
             appsCollection.doc(id).get().then(doc => {
                const app = doc.data();
                if (app) {
                    window.currentAppId = id; 
                    
                    document.getElementById('detailsIcon').src = app.iconPath || 'https://via.placeholder.com/80/4a6bff/ffffff?text=Icon';
                    document.getElementById('detailsTitle').textContent = app.name;

                    document.getElementById('detailsCategory').textContent = app.category;
                    document.getElementById('detailsDescription').textContent = app.fullDescription || app.shortDescription || 'لا يتوفر وصف حالياً لهذا التطبيق.'; 
                    document.getElementById('detailsVersion').textContent = `${app.version || 'غير محدد'}`;
                    document.getElementById('detailsSize').textContent = `${app.size || 'غير محدد'} ميغابايت`;
                    
                    const ratingContainer = document.getElementById('detailsRating');
                    const ratingValue = parseFloat(app.rating) || 0;
                    const fullStars = Array(Math.floor(ratingValue)).fill('<i class="fas fa-star filled"></i>').join('');
                    const emptyStars = Array(5 - Math.floor(ratingValue)).fill('<i class="fas fa-star"></i>').join('');

                    ratingContainer.innerHTML = `${ratingValue.toFixed(1)} ${fullStars}${emptyStars}`;

                    document.getElementById('detailsDownloads').textContent = `${app.downloads || 0}`;
                    
                    const screenshotsContainer = document.getElementById('detailsScreenshots');
                    screenshotsContainer.innerHTML = '';
                    
                    if (Array.isArray(app.screenshotsPaths)) { 
                        app.screenshotsPaths.forEach(src => {
                            const img = document.createElement('img');
                            img.src = src;
                            img.alt = 'لقطة شاشة للتطبيق';
                            img.onclick = () => openModal(src);
                            screenshotsContainer.appendChild(img);
                        });
                    }
                    
                    document.getElementById('appDetailsModal').style.display = 'block';
                } else {
                    showToast('لم يتم العثور على التطبيق.');
                }
            }).catch(error => {
                console.error("Error fetching document: ", error);
                showToast('حدث خطأ أثناء جلب التفاصيل.');
            });
        }


        // دالة التحميل النهائية (لم تتغير)
        window.downloadApp = function(id, buttonElement = null) {
            // ... (الكود الخاص بالتحميل وتحديث العداد) ...
            let btn = buttonElement;
            if (!btn) {
                btn = document.querySelector('.download-modal-btn');
            }
            
            if (btn) {
                btn.classList.add('loading');
            }

            appsCollection.doc(id).get().then(doc => {
                if (doc.exists) {
                    const appData = doc.data();
                    const currentDownloads = appData.downloads || 0;

                    appsCollection.doc(id).update({
                        downloads: currentDownloads + 1
                    }).then(() => {
                        
                        if (appData.downloadLink) { 
                            const downloadLinkElement = document.createElement('a');
                            downloadLinkElement.href = appData.downloadLink; 
                            downloadLinkElement.download = appData.name || 'app_file'; 

                            document.body.appendChild(downloadLinkElement);
                            downloadLinkElement.click();
                            document.body.removeChild(downloadLinkElement); 
                        } else {
                            console.warn(`Error: 'downloadLink' field missing for app: ${appData.name}`);
                            showToast(`خطأ: لم يتم العثور على ملف تحميل للتطبيق "${appData.name}".`, 5000); 
                            
                            if (btn) {
                                btn.classList.remove('loading');
                            }
                            return; 
                        }

                        setTimeout(() => {
                            if (btn) {
                                btn.classList.remove('loading');
                            }
                            showToast(`تم بدء تحميل "${appData.name}" بنجاح!`);
                        }, 2000);

                    }).catch(error => {
                        console.error("Error updating downloads: ", error);
                        if (btn) {
                            btn.classList.remove('loading');
                        }
                        showToast('حدث خطأ أثناء تحديث عدد التنزيلات.');
                    });

                } else {
                    if (btn) {
                        btn.classList.remove('loading');
                    }
                    showToast('لم يتم العثور على التطبيق.');
                }
            }).catch(error => {
                console.error("Error getting document: ", error);
                if (btn) {
                    btn.classList.remove('loading');
                }
                showToast('حدث خطأ أثناء جلب بيانات التطبيق.');
            });
        }


        // وظيفة تصفية التطبيقات (تم استرجاعها)
        function filterApps(category) {
            const appCards = document.querySelectorAll('.app-card');
            appCards.forEach(card => {
                const cardCategory = card.getAttribute('data-category');
                if (category === 'الكل' || cardCategory === category) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function openModal(src) {
            document.getElementById('modalImage').src = src;
            document.getElementById('imageModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const appModal = document.getElementById('appDetailsModal');
            const imageModal = document.getElementById('imageModal');
            
            if (event.target === appModal) {
                appModal.style.display = 'none';
            }
            if (event.target === imageModal) {
                imageModal.style.display = 'none';
            }
        }

        document.getElementById('contactForm').addEventListener('submit', function(e) {
            e.preventDefault();
            showToast('تم إرسال رسالتك بنجاح! سنتواصل معك قريبًا.');
            this.reset();
        });
    </script>
</body>
</html>
